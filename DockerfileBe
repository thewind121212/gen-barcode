
# --- Build stage ---
FROM node:20-alpine AS builder
WORKDIR /app

# Base tsconfig used by the backend tsconfig
COPY ./tsconfig.base.json ./tsconfig.base.json

# Install dependencies for the backend (including dev deps for TypeScript build)
WORKDIR /app/be
COPY ./be/package.json ./be/package-lock.json* ./
COPY ./be/tsconfig*.json ./
RUN if [ -f package-lock.json ]; then npm ci; else npm install; fi

# Bun is required because backend scripts use bunx during build
ENV BUN_INSTALL=/usr/local/bun
RUN apk add --no-cache curl bash && \
  curl -fsSL https://bun.sh/install | bash && \
  ln -sf /usr/local/bun/bin/bun /usr/local/bin/bun && \
  ln -sf /usr/local/bun/bin/bunx /usr/local/bin/bunx

# Copy backend source
COPY ./be .

# Set a dummy DATABASE_URL so prisma.config.ts can load during build
ENV DATABASE_URL="postgresql://user:password@localhost:5432/postgres"

# Generate Prisma client and build TypeScript to JavaScript
RUN npx prisma generate && \
  # Ensure Prisma client path matches our imports
  if [ -f generated/prisma/index.js ] && [ ! -f generated/prisma/client.js ]; then \
    ln -s index.js generated/prisma/client.js; \
  fi && \
  npm run build && \
  mkdir -p node_modules/@Ciri && \
  cd node_modules/@Ciri && \
  ln -s ../../dist/core core && \
  ln -s ../../dist/sentry sentry && \
  ln -s ../../dist/generated generated && \
  ln -s ../../dist/config.js config


# --- Runtime stage ---
FROM node:20-alpine AS runner
WORKDIR /app

# Install Bun (for fast runtime) and PM2 to manage the process
ENV BUN_INSTALL=/usr/local/bun
RUN apk add --no-cache curl bash && \
  curl -fsSL https://bun.sh/install | bash && \
  ln -sf /usr/local/bun/bin/bun /usr/local/bin/bun && \
  ln -sf /usr/local/bun/bin/bunx /usr/local/bin/bunx && \
  npm install -g pm2@5

# Copy built app and runtime dependencies from builder
COPY --from=builder /app/be/node_modules ./node_modules
COPY --from=builder /app/be/dist ./dist
COPY --from=builder /app/be/prisma ./prisma
COPY --from=builder /app/be/generated ./generated
COPY --from=builder /app/be/ecosystem.config.cjs ./ecosystem.config.cjs

# Use non-root user for security
RUN chown -R node:node /app
USER node

EXPOSE 9190

# Use pm2-runtime with ecosystem file as recommended for Docker
CMD ["pm2-runtime", "ecosystem.config.cjs", "--only", "ciri-be"]
